<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actionable</title>
    <!-- Use Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS library for XLSX export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen bg-gray-900 text-white">

    <div class="container mx-auto p-6 bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-center text-yellow-400 mb-4">Actionable</h1>
        
        <p class="text-sm text-gray-400 mb-4 text-center">
            Paste your order data below to extract, send, or download.
        </p>

        <!-- Textarea for user input -->
        <textarea id="inputText" rows="10" class="w-full p-4 border-2 border-gray-700 bg-gray-700 text-white rounded-lg focus:outline-none focus:border-yellow-400 transition-colors placeholder-gray-500" placeholder="Paste order data here..."></textarea>
        
        <!-- Action Buttons -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <!-- Button to trigger the extraction and sending -->
            <button onclick="processOrders()" class="w-full py-3 bg-yellow-400 text-gray-900 font-bold rounded-lg shadow-md hover:bg-yellow-500 transition-colors">
                Send to Sheet
            </button>

            <!-- Button to download data as XLSX -->
            <button onclick="downloadXLSX()" class="w-full py-3 bg-green-500 text-gray-900 font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors">
                Download XLSX
            </button>

            <!-- Button to open the Dark Store page -->
            <button onclick="openDarkStore()" class="w-full py-3 bg-blue-500 text-gray-900 font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                Open Dark Store
            </button>
        </div>


        <!-- Div to display the extraction and upload status -->
        <div id="output" class="mt-8 p-6 bg-gray-700 rounded-lg border border-gray-600 min-h-[100px] max-h-[400px] overflow-y-auto">
            <p class="text-gray-400 text-center">Status updates will appear here...</p>
        </div>
    </div>

    <script>
        // --- HELPER FUNCTIONS ---

        /**
         * Extracts order data from the input text using regex.
         * @param {string} inputText The raw text containing order information.
         * @returns {Array<Object>} An array of objects, each with an orderId and deadline.
         */
        function extractDataFromText(inputText) {
            const regex = /(\d{5,})\n[\s\S]*?(-?\d+h)?\s*(-?\d+min)/g;
            let matches;
            const extractedData = [];

            while ((matches = regex.exec(inputText)) !== null) {
                const orderId = matches[1];
                let hours = matches[2] || '';
                let minutes = matches[3] || '';

                // This function formats the time parts correctly
                const processTimePart = (timePart) => {
                    if (!timePart) return '';
                    const numberMatch = timePart.match(/-?(\d+)/);
                    if (!numberMatch) return timePart;
                    const number = parseInt(numberMatch[1]);
                    const unit = timePart.replaceAll(numberMatch[0], '');
                    return timePart.startsWith('-') ? `${number}${unit}` : `-${number}${unit}`;
                };

                const processedHours = processTimePart(hours);
                const processedMinutes = processTimePart(minutes);
                const deadline = (processedHours + ' ' + processedMinutes).trim();

                extractedData.push({ OrderID: orderId, Deadline: deadline });
            }
            return extractedData;
        }


        // --- BUTTON ACTIONS ---

        /**
         * Processes orders and sends them to a Google Sheet.
         */
        async function processOrders() {
            // IMPORTANT: Replace this placeholder with your actual Google Apps Script Web App URL
            const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbxH4gorXkyfuofGu-UxXn1cK0YTJw45cDYYqNBvxKvhIf5_BcfXxFxkXZSG4XCeQowNdA/exec'; 

            const inputText = document.getElementById('inputText').value;
            const outputDiv = document.getElementById('output');

            if (appsScriptUrl.includes('YOUR_GOOGLE_APPS_SCRIPT_URL_HERE')) {
                outputDiv.innerHTML = '<p class="text-red-400 text-center">❌ Error: Please update the Google Apps Script URL in the code.</p>';
                return;
            }

            outputDiv.innerHTML = '<p class="text-gray-400 text-center animate-pulse">Extracting...</p>';
            
            const extractedData = extractDataFromText(inputText);

            if (extractedData.length > 0) {
                outputDiv.innerHTML = `<p class="text-gray-400 text-center">Extracted ${extractedData.length} orders. Sending to Google Sheet...</p>`;
                
                try {
                    // Note: 'no-cors' mode means we won't get a response back, but the request will be sent.
                    // This is a common requirement when posting to Google Apps Scripts from a browser.
                    await fetch(appsScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(extractedData),
                    });

                    outputDiv.innerHTML = `<p class="text-green-400 font-semibold text-center">✅ Success! Data sent to your Google Sheet.</p>`;
                } catch (error) {
                    outputDiv.innerHTML = `<p class="text-red-400 font-semibold text-center">❌ Error: Failed to send data. Check your URL and script deployment.</p>`;
                    console.error("Error sending data:", error);
                }
            } else {
                outputDiv.innerHTML = '<p class="text-yellow-400 text-center">No valid orders found. Please check your input text format.</p>';
            }
        }

        /**
         * Extracts data and triggers a download as an XLSX file.
         */
        function downloadXLSX() {
            const inputText = document.getElementById('inputText').value;
            const outputDiv = document.getElementById('output');
            
            outputDiv.innerHTML = '<p class="text-gray-400 text-center animate-pulse">Extracting data for download...</p>';
            
            const extractedData = extractDataFromText(inputText);

            if (extractedData.length > 0) {
                // Create a new worksheet from the JSON data
                const worksheet = XLSX.utils.json_to_sheet(extractedData);
                // Create a new workbook
                const workbook = XLSX.utils.book_new();
                // Append the worksheet to the workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, "Orders");
                
                // Trigger the file download
                XLSX.writeFile(workbook, "ExtractedOrders.xlsx");

                outputDiv.innerHTML = `<p class="text-green-400 font-semibold text-center">✅ Success! ${extractedData.length} orders downloaded.</p>`;
            } else {
                outputDiv.innerHTML = '<p class="text-yellow-400 text-center">No valid orders found to download.</p>';
            }
        }

        /**
         * Navigates to the darkstore.html page.
         */
        function openDarkStore() {
            window.open('darkstore.html', '_blank');
        }

    </script>
</body>
</html>
