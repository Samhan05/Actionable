<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Processor for Dispatch Actions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for creating XLSX files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a better look in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
        
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Log Processor for Dispatch Actions</h1>
            <p class="text-gray-400 mt-2">Paste your chat log to automatically extract order IDs and required actions.</p>
        </header>

        <!-- Instructions Section -->
        <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600">
            <h2 class="text-lg font-semibold text-white mb-2">Instructions & Rules</h2>
            <ul class="list-disc list-inside text-gray-300 space-y-1 text-sm">
                <li>Order IDs are 7-10 digit numbers or start with "obs-".</li>
                <li>If an order appears multiple times, the action from its latest appearance is used.</li>
                <li><b>Drop off / Return:</b> Keywords like <span class="font-mono bg-gray-600 px-1 rounded">return</span>, <span class="font-mono bg-gray-600 px-1 rounded">complete</span>, <span class="font-mono bg-gray-600 px-1 rounded">تم الارجاع</span>, <span class="font-mono bg-gray-600 px-1 rounded">otp</span>.</li>
                <li><b>Cancel:</b> Keywords like <span class="font-mono bg-gray-600 px-1 rounded">cancel</span>, <span class="font-mono bg-gray-600 px-1 rounded">الغاء</span>. (Overridden by Drop off/Return).</li>
                 <li><b>Pick-up:</b> Keywords like <span class="font-mono bg-gray-600 px-1 rounded">make pickup</span>, <span class="font-mono bg-gray-600 px-1 rounded">pickup from your side</span>.</li>
                <li><b>Re-dispatch:</b> Dispatch issues (<span class="font-mono bg-gray-600 px-1 rounded">late</span>, <span class="font-mono bg-gray-600 px-1 rounded">need car</span>, etc.) with a reply (<span class="font-mono bg-gray-600 px-1 rounded">1 reply</span>, <span class="font-mono bg-gray-600 px-1 rounded">View thread</span>).</li>
                <li><b>Rider Notified:</b> Dispatch issues without a reply.</li>
            </ul>
        </div>

        <!-- Input and Actions -->
        <div class="space-y-4">
            <textarea id="logInput" class="w-full h-48 p-4 bg-gray-900 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y" placeholder="Paste your raw chat log here..."></textarea>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button id="processBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
                    Process Log
                </button>
                <button id="copyBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
                    Copy to Clipboard
                </button>
                <button id="downloadBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
                    Download as XLSX
                </button>
                <a href="Home.html" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 text-center">
                    Actionable
                </a>
            </div>
        </div>

        <!-- Results Display -->
        <div id="resultsContainer" class="bg-gray-900 p-4 rounded-lg border border-gray-600">
            <h2 class="text-xl font-semibold text-white mb-4">Results</h2>
            <div class="overflow-auto max-h-80">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Order ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Action Taken</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="bg-gray-900 divide-y divide-gray-700">
                        <!-- Results will be populated here -->
                         <tr>
                            <td colspan="2" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No logs processed yet.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Custom Notification/Alert Box -->
    <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all duration-300">
        Copied to clipboard!
    </div>

    <script>
        // DOM element references
        const logInput = document.getElementById('logInput');
        const processBtn = document.getElementById('processBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const resultsBody = document.getElementById('resultsBody');
        const notification = document.getElementById('notification');

        // --- Event Listeners ---
        processBtn.addEventListener('click', () => {
             const results = getProcessedResults();
             updateResultsTable(results);
        });
        copyBtn.addEventListener('click', copyToClipboard);
        downloadBtn.addEventListener('click', downloadXLSX);

        /**
         * Core function to process text and return a map of results.
         * @returns {Map<string, string>} A map of order IDs to their actions.
         */
        function getProcessedResults() {
            const rawText = logInput.value;
            if (!rawText.trim()) {
                return new Map();
            }

            const orderIdRegexForTest = /\b(\d{7,10}|obs-[\w-]+)\b/;
            const orderIdRegexGlobal = /\b(\d{7,10}|obs-[\w-]+)\b/g;

            // --- PRE-PROCESSING STEP (V5) ---
            let lines = rawText.split('\n');
            const transformedLines = [];
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes("replied to a thread:")) {
                    if (i + 2 < lines.length) {
                        const idLine = lines[i + 1];
                        const contentLine = lines[i + 2];
                        const orderIdMatches = idLine.match(orderIdRegexGlobal);

                        if (orderIdMatches) {
                            orderIdMatches.forEach(orderId => {
                                transformedLines.push(`${orderId} ${contentLine} 1 reply`);
                            });
                            i += 2;
                            continue;
                        }
                    }
                }
                transformedLines.push(lines[i]);
            }
            lines = transformedLines;
            
            // --- REBUILT Main Processing Logic (V6 - Forward Looking) ---
            const messageBlocks = [];
            let idBuffer = [];

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;

                const idsInLine = trimmedLine.match(orderIdRegexGlobal) || [];
                const textInLine = trimmedLine.replace(orderIdRegexGlobal, '').trim();

                if (idsInLine.length > 0 && textInLine.length === 0) {
                    // This line ONLY contains IDs, so add them to the buffer.
                    idBuffer.push(...idsInLine);
                } else if (idsInLine.length > 0 && textInLine.length > 0) {
                    // This line contains both IDs and text. It's a new message block.
                    // First, finalize any previous block that was waiting for context.
                    if (idBuffer.length > 0) {
                        messageBlocks.push({ ids: [...idBuffer], context: trimmedLine });
                        idBuffer = [];
                    } else {
                        // This is a self-contained message.
                        messageBlocks.push({ ids: idsInLine, context: trimmedLine });
                    }
                } else if (idsInLine.length === 0 && textInLine.length > 0 && idBuffer.length > 0) {
                    // This line is the context for the buffered IDs.
                    const fullContext = [trimmedLine];
                    // Finalize the block.
                    messageBlocks.push({ ids: [...idBuffer], context: fullContext.join(' ') });
                    idBuffer = []; // Clear the buffer
                }
            }

            // --- CONTEXT AGGREGATION ---
            // This step combines a message block with subsequent context lines (like "1 reply")
            const finalResults = new Map();
            for (let i = 0; i < messageBlocks.length; i++) {
                let currentBlock = messageBlocks[i];
                let combinedContext = currentBlock.context;

                // Find the original line number of the context to look ahead from there
                let originalContextIndex = -1;
                for(let k=0; k < lines.length; k++) {
                    if(lines[k].includes(currentBlock.context.split(' ')[0])) { // Find first word of context
                        originalContextIndex = k;
                        break;
                    }
                }

                if(originalContextIndex !== -1) {
                    for (let j = originalContextIndex + 1; j < lines.length; j++) {
                        const nextLine = lines[j].trim();
                        if (orderIdRegexForTest.test(nextLine)) {
                            break; // Stop if we hit a new order ID
                        }
                        if (nextLine) {
                            combinedContext += ' ' + nextLine;
                        }
                    }
                }
                
                const action = determineAction(combinedContext.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                currentBlock.ids.forEach(id => {
                    finalResults.set(id, action);
                });
            }

            return finalResults;
        }


        /**
         * Determines the correct action for a given line of text based on predefined rules.
         */
        function determineAction(line) {
            const isDropOff = /ret(u|a|e)?rn|comp(l|e|a)?ete|تم ?الارجاع|مرتجع|otp/i.test(line);
            const isCancel = /can(c|s|k)el|الغاء|cancl/i.test(line);
            const isPickup = /(make|mke) ?pickup|pickup from (ur|your) side|pick ?up (the )?order/i.test(line);
            const isSendNumber = /number|رقم ?المندوب|رقم ?السائق|contact number/i.test(line);
            const isCheckHistory = /history|سجل ?العميل/i.test(line);

            if (isDropOff) return 'Drop off / Return';
            if (isCancel) return 'Cancel';
            if (isPickup) return 'Pick-up';
            if (isSendNumber) return 'Sent Rider/Customer Number';
            if (isCheckHistory) return 'Check Customer History';

            const isDispatchIssue = /l(a|e)te|متاخر|تاخر|order ?ready|follow ?up|no ?rider|change ?rider|need ?(car|سياره)|assign ?driver|الطلب ?كبير|rider is very late|تغيير المندوب/i.test(line);
            if (isDispatchIssue) {
                const hasReply = /\d+\s+repl(y|ies)|view thread/i.test(line);
                return hasReply ? 'Re-dispatch' : 'Rider Notified';
            }

            return 'No Action Identified';
        }

        /**
         * Updates the results table in the DOM with the processed data.
         */
        function updateResultsTable(results) {
            resultsBody.innerHTML = '';

            if (results.size === 0) {
                resultsBody.innerHTML = `<tr><td colspan="2" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No valid order IDs found or log is empty.</td></tr>`;
                return;
            }
            
            const sortedResults = new Map([...results.entries()].sort());

            sortedResults.forEach((action, orderId) => {
                if (action === 'No Action Identified') return;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 transition-colors duration-150';

                const orderIdCell = document.createElement('td');
                orderIdCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-white';
                orderIdCell.textContent = orderId;

                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-300';
                actionCell.textContent = action;

                row.appendChild(orderIdCell);
                row.appendChild(actionCell);
                resultsBody.appendChild(row);
            });

            if (resultsBody.innerHTML === '') {
                 resultsBody.innerHTML = `<tr><td colspan="2" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No actions could be identified from the log.</td></tr>`;
            }
        }

        /**
         * Copies the content of the results table to the clipboard in a tab-separated format.
         */
        function copyToClipboard() {
            const rows = resultsBody.querySelectorAll('tr');
            if (rows.length === 0 || (rows.length > 0 && rows[0].querySelectorAll('td').length < 2)) {
                showNotification("Nothing to copy!", true);
                return;
            }

            let clipboardText = 'Order ID\tAction Taken\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 2) {
                    clipboardText += `${cells[0].textContent}\t${cells[1].textContent}\n`;
                }
            });

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = clipboardText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                showNotification("Copied to clipboard!");
            } catch (err) {
                console.error('Failed to copy: ', err);
                showNotification("Failed to copy!", true);
            }

            document.body.removeChild(tempTextArea);
        }

        /**
         * Generates and downloads an XLSX file from the results table.
         */
        function downloadXLSX() {
            const results = getProcessedResults();

            const sortedResults = new Map([...results.entries()].sort());
            
            const data = [
                ['Order ID', 'Action Taken']
            ];
            sortedResults.forEach((action, orderId) => {
                if (action !== 'No Action Identified') {
                    data.push([orderId, action]);
                }
            });

            if (data.length <= 1) {
                showNotification("No data to download!", true);
                return;
            }

            try {
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Log Results");
                XLSX.writeFile(workbook, "log_results.xlsx");
            } catch (err) {
                console.error('Failed to generate XLSX file: ', err);
                showNotification("Failed to create file!", true);
            }
        }
        
        /**
         * Displays a temporary notification message.
         */
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.remove('bg-green-500', 'bg-red-500');
            notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            notification.classList.remove('opacity-0', 'translate-y-2');
            notification.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-y-0');
                notification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        }
    </script>
</body>
</html>
